from infra.db.models.users import User
from infra.db.models.tasks import Task
from infra.db.repository.user_repo import UserRepository
from infra.db.repository.task_repo import TaskRepository
from infra.db.repository.group_repo import GroupRepository
from infra.security.password_utils import hash_password, check_password
from infra.security.token.factory import TokenHandlerFactory as handler_factory
from infra.security.token.exceptions import TokenError
from infra.security.token.base_handler import TokenHandler
from infra.security.permissions.abstract import AbstractPermission
from infra.security.permissions.exc import PermissionException
from api.schemas.users_schemas import LoginSchema, UserCreateSchema, ChangePasswordSchema
from tasks.email import send_mail
from .exceptions import UserAuthServiceError, UserPermissionServiceError


class BaseUserService:
    def __init__(self, user_repository: UserRepository):
        self.repo = user_repository


class UserService(BaseUserService):
    def __init__(self, user_repository, task_repository: TaskRepository):
        super().__init__(user_repository)
        self.task_repo = task_repository

    async def get_user_tasks(self, user_id: int) -> list[Task]:
        user = await self.repo.get_user_and_tasks(user_id)
        return user.tasks


class UserAuthService(BaseUserService):
    def check_user_password(self, password: str, user: User):
        if not check_password(password, user.password):
            raise UserAuthServiceError(
                'Wrong password')

    async def validate_user_by_url_token(self, token: str, token_handler: TokenHandler):
        try:
            return await self.validate_user_by_token(token, token_handler)
        except UserAuthServiceError:
            raise UserAuthServiceError('Wrong url or expired')

    async def validate_user_by_token(self, token: str, token_handler: TokenHandler):
        try:
            payload = token_handler.validate_token(token, ['user_id'])
        except TokenError as e:
            raise UserAuthServiceError(str(e), e)
        user = await self.repo.get_user(payload['user_id'])
        if not user:
            raise UserAuthServiceError(
                'Not existing user_id was set in token payload. Security threat!')
        return user

    async def auth_user(self, token: str):
        jwt_handler = handler_factory.get_jwt_handler()
        return await self.validate_user_by_token(token, jwt_handler)

    async def login_user(self, login_schema: LoginSchema):
        email, password = login_schema.email, login_schema.password
        user = await self.repo.get_user_by_email(email)
        if not user:
            raise UserAuthServiceError(
                f'Unable to find user with email ({email})')
        self.check_user_password(password, user)
        return user

    async def registration_request(self, register_schema: UserCreateSchema):
        raw_password = register_schema.password
        password = hash_password(raw_password)
        register_schema.password = password
        registered = await self.repo.create_user(**register_schema.model_dump(exclude_none=True))
        token_handler = handler_factory.get_serializer_token_handler()
        confirm_url = token_handler.make_disp_url_for_user(
            'http://localhost:8000/api/profile/confirm/registration/', registered)
        msg = f'Please follow the link for confirm your registration\n{confirm_url}'
        send_mail.delay('Confirm registration', msg, registered.email)

    async def confirm_registration(self, url_token: str):
        token_handler = handler_factory.get_serializer_token_handler()
        user = await self.validate_user_by_url_token(url_token, token_handler)
        if user.is_active:
            raise UserAuthServiceError('Your account is already activated')
        await self.repo.update_user(user.id, is_active=True)

    async def change_password_request(self, user_id: int):
        user = await self.repo.get_user(user_id)
        token_handler = handler_factory.get_serializer_token_handler()
        confirm_url = token_handler.make_disp_url_for_user(
            'http://localhost:8000/api/confirm/change_password/', user)
        msg = f'Please follow the link to confirm change password\n{confirm_url}'
        send_mail.delay('Confirm change password', msg, user.email)

    async def confirm_change_password(self, url_token: str, password_change_schema: ChangePasswordSchema):
        token_handler = handler_factory.get_serializer_token_handler()
        user = await self.validate_user_by_url_token(url_token, token_handler)
        self.check_user_password(password_change_schema.current_password, user)
        new_password = hash_password(password_change_schema.new_password)
        await self.repo.update_user(user.id, password=new_password)


class UserPermissionService(BaseUserService):
    def __init__(self, permission_objs: list[AbstractPermission]):
        self.perm_objs = permission_objs

    def check(self, user: User) -> User:
        for perm in self.perm_objs:
            try:
                perm.check_user(user)
            except PermissionException as e:
                raise UserPermissionServiceError(str(e), e)
        return user
